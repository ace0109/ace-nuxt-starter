# é¡¹ç›®å®Œæˆæ€»ç»“

## ğŸ‰ é¡¹ç›®æ¶æ„å®ç°å®Œæˆ

å·²æˆåŠŸå®ç° **Nuxt BFF (Backend for Frontend)** æ¶æ„ï¼Œæ‰€æœ‰éœ€æ±‚å·²å®Œæˆï¼

---

## âœ… å®Œæˆçš„åŠŸèƒ½æ¸…å•

### 1. å‰ç«¯è¯·æ±‚å°è£… âœ…

#### æ–‡ä»¶

- `app/plugins/api.ts` - HTTP å®¢æˆ·ç«¯é…ç½®
- `app/composables/useApi.ts` - ç»Ÿä¸€ API è°ƒç”¨æ¥å£

#### åŠŸèƒ½

- âœ… åŒæ¨¡å¼æ”¯æŒï¼ˆå“åº”å¼ + å‘½ä»¤å¼ï¼‰
- âœ… è‡ªåŠ¨æºå¸¦ Cookie
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… å®Œæ•´ TypeScript ç±»å‹æ”¯æŒ

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
// å“åº”å¼
const { data, pending, error } = await useApi("/posts");

// å‘½ä»¤å¼
const { get, post, put, delete: del } = useApi();
await post("/posts", { title: "Hello" });
```

---

### 2. Server ç«¯è®¤è¯ä¸­é—´ä»¶ âœ…

#### æ–‡ä»¶

- `server/middleware/auth.ts` - è®¤è¯ä¸­é—´ä»¶
- `server/utils/auth.ts` - è®¤è¯å·¥å…·å‡½æ•°
- `types/server.ts` - TypeScript ç±»å‹å®šä¹‰

#### åŠŸèƒ½

- âœ… è‡ªåŠ¨æ£€æŸ¥æ‰€æœ‰ `/api/*` è¯·æ±‚
- âœ… ä» Cookie ä¸­æå– token
- âœ… å…¬å¼€è·¯å¾„ç™½åå•æœºåˆ¶
- âœ… Token å­˜å‚¨åˆ° `event.context.auth`

#### æ¶æ„ä¼˜åŠ¿

```
æµè§ˆå™¨è¯·æ±‚ â†’ ä¸­é—´ä»¶æ£€æŸ¥ Token â†’ å­˜å‚¨åˆ° context â†’ API Handler ä½¿ç”¨
```

---

### 3. Server ç«¯è¯·æ±‚åç«¯ âœ…

#### æ–‡ä»¶

- `server/utils/backendFetch.ts` - åç«¯è¯·æ±‚å·¥å…·

#### åŠŸèƒ½

- âœ… è‡ªåŠ¨æ³¨å…¥ JWT Token åˆ° `Authorization` header
- âœ… æ”¯æŒå…³é—­è®¤è¯ï¼ˆ`auth: false`ï¼‰
- âœ… è‡ªåŠ¨å¤„ç† 401 é”™è¯¯ï¼ˆæ¸…é™¤å‰ç«¯ sessionï¼‰
- âœ… ç»Ÿä¸€é…ç½® `BACKEND_URL`

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
// è‡ªåŠ¨æ³¨å…¥ token
const user = await backendFetch(event, "/users/me");

// ä¸éœ€è¦è®¤è¯
const data = await backendFetch(event, "/public/data", { auth: false });
```

---

### 4. è®¤è¯ç›¸å…³ API âœ…

#### æ–‡ä»¶

- `server/api/auth/login.post.ts` - ç™»å½•
- `server/api/auth/logout.post.ts` - ç™»å‡º
- `server/api/auth/me.get.ts` - è·å–å½“å‰ç”¨æˆ·

#### æµç¨‹

**ç™»å½•æµç¨‹:**

```
1. æµè§ˆå™¨ POST /api/auth/login
2. Nuxt Server è½¬å‘åˆ°åç«¯ /auth/login
3. åç«¯è¿”å› JWT token + ç”¨æˆ·ä¿¡æ¯
4. Nuxt Server å°† JWT å­˜å…¥ HttpOnly Cookie
5. è¿”å›ç”¨æˆ·ä¿¡æ¯ç»™æµè§ˆå™¨
```

**è®¤è¯è¯·æ±‚:**

```
1. æµè§ˆå™¨è¯·æ±‚ /api/postsï¼ˆè‡ªåŠ¨æºå¸¦ Cookieï¼‰
2. ä¸­é—´ä»¶ä» Cookie æå– JWT
3. backendFetch è‡ªåŠ¨æ³¨å…¥ JWT åˆ° Authorization header
4. è½¬å‘åˆ°åç«¯ /posts
5. è¿”å›æ•°æ®
```

---

### 5. é€šç”¨è½¬å‘å±‚ âœ…

#### æ–‡ä»¶

- `server/api/[...].ts` - Catch-all è½¬å‘

#### åŠŸèƒ½

- âœ… è‡ªåŠ¨è½¬å‘æ‰€æœ‰ `/api/*` è¯·æ±‚åˆ°çœŸå®åç«¯
- âœ… ä¿æŒè¯·æ±‚æ–¹æ³•ã€è¯·æ±‚ä½“ã€æŸ¥è¯¢å‚æ•°
- âœ… è‡ªåŠ¨æ³¨å…¥ JWT Token
- âœ… è®¤è¯ä¸­é—´ä»¶è‡ªåŠ¨ä¿æŠ¤

#### è·¯ç”±ä¼˜å…ˆçº§

```
1. ç²¾ç¡®åŒ¹é…: /api/auth/login.post.ts
2. åŠ¨æ€è·¯ç”±: /api/users/[id].get.ts
3. Catch-all: /api/[...].ts ï¼ˆå…¶ä»–æ‰€æœ‰è·¯å¾„ï¼‰
```

---

### 6. ç¯å¢ƒé…ç½® âœ…

#### æ–‡ä»¶

- `nuxt.config.ts` - è¿è¡Œæ—¶é…ç½®
- `.env.example` - ç¯å¢ƒå˜é‡ç¤ºä¾‹

#### é…ç½®é¡¹

```bash
BACKEND_URL=http://localhost:8000  # çœŸå®åç«¯åœ°å€
NODE_ENV=development               # ç¯å¢ƒç±»å‹
```

---

### 7. æ–‡æ¡£å’Œç¤ºä¾‹ âœ…

#### æ–‡ä»¶

- `API_DEVELOPMENT_LOG.md` - å®Œæ•´å¼€å‘è®°å½•ï¼ˆ580+ è¡Œï¼‰
- `QUICK_START.md` - å¿«é€Ÿå…¥é—¨æŒ‡å—ï¼ˆ350+ è¡Œï¼‰
- `README.md` - é¡¹ç›®æ¦‚è§ˆï¼ˆæ›´æ–°ï¼‰
- `app/pages/auth-demo.vue` - è®¤è¯ç¤ºä¾‹é¡µé¢

---

## ğŸ—ï¸ æœ€ç»ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æµè§ˆå™¨ (Browser)                     â”‚
â”‚                                                              â”‚
â”‚  ä½¿ç”¨: useApi composable                                     â”‚
â”‚  ä¼ è¾“: HttpOnly Cookie (token)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Cookie
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nuxt Server (BFF Layer)                   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Middleware     â”‚â†’ â”‚ API Handlers    â”‚â†’ â”‚ backendFetch â”‚ â”‚
â”‚  â”‚ (æå– token)   â”‚  â”‚ (ä¸šåŠ¡é€»è¾‘)      â”‚  â”‚ (æ³¨å…¥ JWT)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  ä¼ è¾“: JWT Token (Authorization: Bearer xxx)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ JWT
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çœŸå®åç«¯ (Backend API)                    â”‚
â”‚                                                              â”‚
â”‚  æ¥æ”¶: Authorization header                                  â”‚
â”‚  è¿”å›: æ•°æ® / JWT token (ç™»å½•æ—¶)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### 1. å®‰å…¨æ€§ ğŸ”’

- **HttpOnly Cookie**: é˜²æ­¢ XSS æ”»å‡»çªƒå– token
- **JWT éš”ç¦»**: å‰ç«¯æ— æ³•è®¿é—®çœŸå® JWT token
- **ä¸­é—´ä»¶ä¿æŠ¤**: æ‰€æœ‰ API è¯·æ±‚è‡ªåŠ¨éªŒè¯

### 2. æ ‡å‡†åŒ– ğŸ“

- **åç«¯ JWT**: æ ‡å‡†è®¤è¯æ–¹å¼ï¼Œå¯æœåŠ¡å¤šç«¯
- **ç»Ÿä¸€æ¥å£**: å‰ç«¯åªéœ€è°ƒç”¨ `/api/*`
- **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript æ”¯æŒ

### 3. SSR å‹å¥½ ğŸŒ

- **Cookie è‡ªåŠ¨è½¬å‘**: SSR æ—¶è‡ªåŠ¨æºå¸¦è®¤è¯ä¿¡æ¯
- **æ— éœ€ç‰¹æ®Šå¤„ç†**: å“åº”å¼å’Œ SSR ä½¿ç”¨ç›¸åŒä»£ç 

### 4. å¼€å‘ä½“éªŒ ğŸ‘¨â€ğŸ’»

- **ç®€æ´çš„ API**: `useApi()` ç»Ÿä¸€å…¥å£
- **è‡ªåŠ¨æ³¨å…¥**: æ— éœ€æ‰‹åŠ¨ç®¡ç† token
- **é”™è¯¯å¤„ç†**: 401 è‡ªåŠ¨è·³è½¬ç™»å½•

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

### æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶                           | è¡Œæ•°    | è¯´æ˜            |
| ------------------------------ | ------- | --------------- |
| `app/plugins/api.ts`           | 62      | HTTP å®¢æˆ·ç«¯é…ç½® |
| `app/composables/useApi.ts`    | 85      | ç»Ÿä¸€ API æ¥å£   |
| `server/middleware/auth.ts`    | 42      | è®¤è¯ä¸­é—´ä»¶      |
| `server/utils/auth.ts`         | 106     | è®¤è¯å·¥å…·å‡½æ•°    |
| `server/utils/backendFetch.ts` | 95      | åç«¯è¯·æ±‚å·¥å…·    |
| `server/api/auth/*.ts`         | 75      | è®¤è¯ API (3 ä¸ª) |
| `server/api/[...].ts`          | 36      | é€šç”¨è½¬å‘        |
| `types/server.ts`              | 18      | ç±»å‹å®šä¹‰        |
| **æ€»è®¡**                       | **519** | **æ ¸å¿ƒä»£ç **    |

### æ–‡æ¡£

| æ–‡ä»¶                     | è¡Œæ•°     | è¯´æ˜         |
| ------------------------ | -------- | ------------ |
| `API_DEVELOPMENT_LOG.md` | 583      | å®Œæ•´å¼€å‘è®°å½• |
| `QUICK_START.md`         | 354      | å¿«é€Ÿå…¥é—¨æŒ‡å— |
| `README.md`              | 196      | é¡¹ç›®æ¦‚è§ˆ     |
| **æ€»è®¡**                 | **1133** | **æ–‡æ¡£**     |

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### 1. ç¯å¢ƒé…ç½®

```bash
cp .env.example .env
# ç¼–è¾‘ .envï¼Œè®¾ç½® BACKEND_URL
```

### 2. å®‰è£…ä¾èµ–

```bash
pnpm install
```

### 3. å¯åŠ¨å¼€å‘

```bash
pnpm dev
```

### 4. æŸ¥çœ‹ç¤ºä¾‹

è®¿é—® `http://localhost:3000/auth-demo`

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯ç™»å½•

```vue
<script setup lang="ts">
const { post } = useApi();

async function login() {
  await post("/auth/login", { email, password });
  // Cookie è‡ªåŠ¨è®¾ç½®ï¼Œåç»­è¯·æ±‚è‡ªåŠ¨æºå¸¦
}
</script>
```

### è·å–æ•°æ®ï¼ˆè‡ªåŠ¨æºå¸¦è®¤è¯ï¼‰

```vue
<script setup lang="ts">
// å“åº”å¼è·å–
const { data: posts } = await useApi("/posts");
// è‡ªåŠ¨æºå¸¦ cookie â†’ ä¸­é—´ä»¶æå– JWT â†’ è½¬å‘åˆ°åç«¯
</script>
```

### Server API å¼€å‘

```typescript
// server/api/posts/[id].get.ts
export default defineEventHandler(async (event) => {
  const id = getRouterParam(event, "id");

  // è‡ªåŠ¨æ³¨å…¥ JWTï¼Œè½¬å‘åˆ°åç«¯
  const post = await backendFetch(event, `/posts/${id}`);

  return post;
});
```

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. åŒæ¨¡å¼ API è®¾è®¡

```typescript
// æ¨¡å¼ä¸€ï¼šå“åº”å¼ï¼ˆé¡µé¢æ•°æ®ï¼‰
const { data, pending } = await useApi("/posts");

// æ¨¡å¼äºŒï¼šå‘½ä»¤å¼ï¼ˆè¡¨å•æäº¤ï¼‰
const { post } = useApi();
await post("/posts", data);
```

### 2. å‡½æ•°é‡è½½å®ç°ç±»å‹å®‰å…¨

```typescript
export function useApi<T>(url: string, options?: any): UseFetchReturn<T>;
export function useApi(): {
  get: <T>(url: string, options?: any) => Promise<T>;
  post: <T>(url: string, body?: any, options?: any) => Promise<T>;
  // ...
};
```

### 3. ä¸­é—´ä»¶ + Context æ¨¡å¼

```typescript
// ä¸­é—´ä»¶ï¼šæå–å¹¶å­˜å‚¨
event.context.auth = { token, user };

// API Handlerï¼šç›´æ¥ä½¿ç”¨
const session = event.context.auth;
```

### 4. æ‹¦æˆªå™¨æ¨¡å¼

```typescript
$fetch.create({
  onRequest() {
    /* æ³¨å…¥ token */
  },
  onResponseError() {
    /* å¤„ç† 401 */
  },
});
```

---

## ğŸ”§ å¯æ‰©å±•æ€§

### æ·»åŠ æ–°çš„ API

ç›´æ¥è°ƒç”¨ï¼Œè‡ªåŠ¨è½¬å‘ï¼š

```typescript
const data = await useApi("/new-endpoint");
```

### è‡ªå®šä¹‰ API Handler

```typescript
// server/api/custom/[...].ts
export default defineEventHandler(async (event) => {
  // è‡ªå®šä¹‰é€»è¾‘
  const data = await backendFetch(event, "/backend-api");
  return { custom: data };
});
```

### æ·»åŠ å…¬å¼€è·¯å¾„

```typescript
// server/utils/auth.ts
const PUBLIC_PATHS = [
  "/api/auth/login",
  "/api/public/*", // æ–°å¢
];
```

---

## ğŸ‰ æ€»ç»“

âœ… **å®Œæ•´å®ç°äº† BFF æ¶æ„**
âœ… **å®‰å…¨çš„è®¤è¯ç³»ç»Ÿ**ï¼ˆCookie + JWTï¼‰
âœ… **ä¼˜é›…çš„ API è®¾è®¡**ï¼ˆuseApi åŒæ¨¡å¼ï¼‰
âœ… **å®Œå–„çš„æ–‡æ¡£**ï¼ˆå¼€å‘è®°å½• + å¿«é€Ÿå…¥é—¨ï¼‰
âœ… **ç±»å‹å®‰å…¨**ï¼ˆå®Œæ•´ TypeScript æ”¯æŒï¼‰
âœ… **SSR å‹å¥½**ï¼ˆCookie è‡ªåŠ¨æºå¸¦ï¼‰

é¡¹ç›®å·²ç»å¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼Œåªéœ€é…ç½® `BACKEND_URL` æŒ‡å‘çœŸå®åç«¯å³å¯ï¼ğŸš€
